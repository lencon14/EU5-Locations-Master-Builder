name: baseline-contract

on:
  pull_request:
  push:

jobs:
  baseline-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine BASE_REF (required in CI)

        shell: pwsh

        env:

          EVENT_NAME: ${{ github.event_name }}

          GITHUB_REF_FULL: ${{ github.ref }}

          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

          PUSH_BEFORE: ${{ github.event.before }}

          PUSH_CREATED: ${{ github.event.created }}

          PUSH_DELETED: ${{ github.event.deleted }}

          PUSH_FORCED: ${{ github.event.forced }}

          PR_BASE_REF: ${{ github.base_ref }}

        run: |

          $ErrorActionPreference = 'Stop'

      

          $baseBranch = ''

          $baseRef = ''

      

          if ($env:EVENT_NAME -eq 'pull_request') {

            $baseBranch = $env:PR_BASE_REF

            $baseRef = "origin/$baseBranch"

          }

          elseif ($env:EVENT_NAME -eq 'push') {

            # タグ等（refs/tags/*）でも落とさず、default branch を基準に安全に倒す

            if (-not ($env:GITHUB_REF_FULL -like 'refs/heads/*')) {

              $baseBranch = $env:DEFAULT_BRANCH

              $baseRef = "origin/$baseBranch"

              Write-Host "Non-branch push ref=$($env:GITHUB_REF_FULL) -> BASE_REF=$baseRef"

            }

            else {

              $pushedBranch = ($env:GITHUB_REF_FULL -replace '^refs/heads/','')

              $baseBranch = $pushedBranch

      

              if ($env:PUSH_DELETED -eq 'true') {

                $baseBranch = $env:DEFAULT_BRANCH

                $baseRef = "origin/$baseBranch"

              }

              else {

                $before = $env:PUSH_BEFORE

                if ($env:PUSH_CREATED -eq 'true' -or $before -match '^(0){40}$') {

                  $baseBranch = $env:DEFAULT_BRANCH

                  $baseRef = "origin/$baseBranch"

                }

                else {

                  $baseRef = $before

                  # force-push 等で before が到達不能な場合は default branch に倒す

                  try {

                    & git cat-file -e "$baseRef^{commit}" 2>$null

                    if ($LASTEXITCODE -ne 0) { throw "missing" }

                  }

                  catch {

                    $baseBranch = $env:DEFAULT_BRANCH

                    $baseRef = "origin/$baseBranch"

                  }

                  finally {

                    $global:LASTEXITCODE = 0

                  }

                }

              }

            }

          }

          else {

            throw "Unsupported event: $($env:EVENT_NAME)"

          }

      

          "BASE_BRANCH=$baseBranch" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          "BASE_REF=$baseRef" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      

          Write-Host "BASE_BRANCH=$baseBranch"

          Write-Host "BASE_REF=$baseRef"

      - name: Fetch base ref explicitly (avoid missing origin/<base>)
        shell: pwsh
        run: |
          git fetch origin ("+refs/heads/{0}:refs/remotes/origin/{0}" -f $env:BASE_BRANCH) --prune

      - name: Detect EU5 map assets (optional)
        shell: pwsh
        run: |
          $gameDir = $env:EU5_GAME_DIR
          $has = $false
          if (-not [string]::IsNullOrWhiteSpace($gameDir)) {
            $mapDir = Join-Path $gameDir "game/in_game/map_data"
            $loc = Join-Path $mapDir "locations.png"
            $riv = Join-Path $mapDir "rivers.png"
            $has = (Test-Path $loc) -and (Test-Path $riv)
          }
          $hasStr = if ($has) { "true" } else { "false" }
          "HAS_EU5_ASSETS=$hasStr" >> $env:GITHUB_ENV
          if (-not $has) {
            Write-Host "[SKIP] EU5 assets not available. Set EU5_GAME_DIR to enable lake diag regression."
          } else {
            Write-Host "[OK] EU5 assets detected."
          }

      - name: Setup Python
        if: ${{ env.HAS_EU5_ASSETS == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python deps (optional)
        if: ${{ env.HAS_EU5_ASSETS == 'true' }}
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path ./requirements.txt) { python -m pip install -r ./requirements.txt } else { Write-Host "No requirements.txt (skip)" }

      - name: Lake diag regression (STRICT PASS)
        if: ${{ env.HAS_EU5_ASSETS == 'true' }}
        shell: pwsh
        run: |
          pwsh -ExecutionPolicy Bypass -File ./tools/run_lake_diag_regression.ps1

      - name: CSV schema contract check
        if: ${{ env.HAS_EU5_ASSETS == 'true' }}
        shell: pwsh
        run: |
          pwsh -ExecutionPolicy Bypass -File ./tools/check_csv_schema_contract.ps1

      - name: Baseline contract check
        shell: pwsh
        env:
          CI: "true"
          BASE_REF: ${{ env.BASE_REF }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BASE_REF)) { throw "BASE_REF is empty (CI contract broken)" }
          pwsh -ExecutionPolicy Bypass -File ./tools/check_baseline_change_contract.ps1
